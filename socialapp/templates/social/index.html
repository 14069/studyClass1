{% extends 'social/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<main class="container my-5">
    <div class="row justify-content-center">
        <section class="col-lg-8">
            <h2 class="mb-4 fw-bold">
                <i class="bi bi-chat-square-text me-2"></i>Postagens Recentes
            </h2>

            {% for postagem in posts %}
                <div class="card shadow-sm border-0 rounded-4 mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="d-flex align-items-center">
                                <!-- Foto do autor -->
                                {% with autor_encontrado=False %}
                                    {% for perfil in perfis %}
                                        {% if perfil.user and perfil.user.username == postagem.autor_postagem %}
                                            {% if perfil.foto_perfil %}
                                                <div class="position-relative me-2">
                                                    <img src="{{ perfil.foto_perfil.url }}" 
                                                        class="rounded-circle" 
                                                        alt="{{ perfil.nome_perfil }}"
                                                        style="width: 36px; height: 36px; object-fit: cover; border: 2px solid #4361ee;">
                                                </div>
                                            {% else %}
                                                <div class="position-relative me-2">
                                                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" 
                                                        style="width: 36px; height: 36px; background-color: #4361ee;">
                                                        <i class="bi bi-person-fill text-white"></i>
                                                    </div>
                                                </div>
                                            {% endif %}
                                            {% with autor_encontrado=True %}{% endwith %}
                                        {% endif %}
                                    {% endfor %}
                                {% endwith %}
                                
                                <!-- Nome do autor e data -->
                                <div>
                                    <h5 class="mb-0 fw-bold">{{ postagem.autor_postagem }}</h5>
                                    <small class="text-muted">
                                        <i class="bi bi-clock me-1"></i>
                                        {{ postagem.data_postagem|date:"d/m/Y H:i" }}
                                    </small>
                                </div>
                            </div>
                            <!-- Botões de opções do post -->
                            {% if postagem.autor_postagem == request.user.username or request.user.is_superuser %}
                            <div class="ms-auto dropdown">
                                <button class="btn btn-sm btn-light rounded-circle"
                                        type="button"
                                        id="postOptions{{ postagem.id_postagem }}"
                                        data-bs-toggle="dropdown"
                                        aria-expanded="false">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end"
                                    aria-labelledby="postOptions{{ postagem.id_postagem }}">
                                    {% if postagem.autor_postagem == request.user.username or request.user.is_superuser %}
                                    <li>
                                        <a class="dropdown-item"
                                           href="{% url 'editar_post' postagem.id_postagem %}">
                                            <i class="bi bi-pencil me-2"></i> Editar
                                            {% if request.user.is_superuser and postagem.autor_postagem != request.user.username %}
                                            <span class="badge bg-warning text-dark ms-2">Admin</span>
                                            {% endif %}
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form action="{% url 'deleta_post' postagem.id_postagem %}" method="POST" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Tem certeza que deseja excluir esta postagem?');">
                                                <i class="bi bi-trash me-2"></i> Excluir
                                                {% if request.user.is_superuser and postagem.autor_postagem != request.user.username %}
                                                <span class="badge bg-warning text-dark ms-2">Admin</span>
                                                {% endif %}
                                            </button>
                                        </form>
                                    </li>
                                    {% endif %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>

                        <h4 class="card-title fw-bold text-primary">
                            {{ postagem.titulo_postagem }}
                        </h4>
                        <p class="card-text">
                            {{ postagem.conteudo_postagem|linebreaksbr }}
                        </p>
                        <!-- Imagem do post -->
                        {% if postagem.imagem_postagem %}
                        <div class="post-image-container mb-3">
                            <img src="{{ postagem.imagem_postagem.url }}" 
                                 alt="Imagem da postagem" 
                                 class="img-fluid rounded" 
                                 style="max-height: 500px; width: 100%; object-fit: contain;">
                        </div>
                        {% endif %}

                        <div class="d-flex gap-2 mt-3">
                            <button type="button" class="btn btn-outline-primary btn-sm like-button" data-post-id="{{ postagem.id_postagem }}">
                                <i class="bi {% if postagem.id_postagem in liked_post_ids %}bi-heart-fill text-danger{% else %}bi-heart{% endif %} me-1"></i>
                                <span class="like-text">Curtir</span>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#comments-{{ postagem.id_postagem }}">
                                <i class="bi bi-chat me-1"></i> Comentar
                            </button>
                        </div>
                        <!-- Contagem de curtidas e comentários -->
                            <div class="mt-2">
                            <span class="fw-bold" id="like-count-{{ postagem.id_postagem }}">{{ postagem.likes.count }}</span>
                            <span class="text-muted">curtida{{ postagem.likes.count|pluralize:"s" }}</span>
                            <span class="mx-2">•</span>
                            <span class="fw-bold" id="comment-count-{{ postagem.id_postagem }}">{{ postagem.comments.count }}</span>
                            <span class="text-muted">comentário{{ postagem.comments.count|pluralize:"s" }}</span>
                        </div>
                        <!-- Seção de Comentários -->
                        <div class="collapse mt-3" id="comments-{{ postagem.id_postagem }}">
                            <hr>
                            <div class="comments-list" id="comments-list-{{ postagem.id_postagem }}" data-post-id="{{ postagem.id_postagem }}" data-next-page="1">
                                <!-- Comentários serão carregados aqui via JavaScript -->
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="no-comments text-center py-3 d-none" id="no-comments-{{ postagem.id_postagem }}">
                                <i class="bi bi-chat-square-text" style="font-size: 2rem;"></i>
                                <p class="mb-0">Nenhum comentário ainda. Seja o primeiro a comentar!</p>
                            </div>
                            <div class="load-more-comments text-center py-2 d-none" id="load-more-{{ postagem.id_postagem }}">
                                <button class="btn btn-sm btn-outline-primary" onclick="loadMoreComments({{ postagem.id_postagem }})">
                                    <i class="bi bi-arrow-down-circle me-1"></i> Carregar mais comentários
                                </button>
                            </div>
                            <form class="comment-form d-flex mt-3" action="{% url 'add_comment' postagem.id_postagem %}" data-post-id="{{ postagem.id_postagem }}" method="POST">
                                {% csrf_token %}
                                {{ comment_form.content }}
                                <button type="submit" class="btn btn-primary btn-sm ms-2">
                                    <i class="bi bi-send"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="alert alert-info">
                    Nenhuma postagem encontrada.
                </div>
            {% endfor %}
        </section>
    </div>
</main>

{% endblock content %}

{% block extra_css %}
<style>
    /* Estilos para as imagens das postagens */
    .post-image-container {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }
    
    .post-image-container img {
        max-height: 500px;
        width: auto;
        max-width: 100%;
        border-radius: 4px;
        transition: transform 0.3s ease;
    }
    
    .post-image-container img:hover {
        transform: scale(1.02);
    }
    
    /* Estilos para os comentários */
    .comment {
        border-left: 3px solid #0d6efd;
        padding-left: 10px;
        margin-bottom: 10px;
    }
    
    .comment-form {
        margin-top: 15px;
    }
    
    .comment-actions {
        font-size: 0.8rem;
    }
    
    .comment-actions a {
        text-decoration: none;
        margin-right: 10px;
    }
    
    .comment-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        margin-right: 10px;
    }
    
    .comment-header {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .comment-username {
        font-weight: bold;
        margin-right: 5px;
    }
    
    .comment-time {
        color: #6c757d;
        font-size: 0.8rem;
    }
    
    .comment-content {
        margin-left: 42px;
    }
    
    .load-more-comments {
        font-size: 0.9rem;
        color: #0d6efd;
        cursor: pointer;
    }
    
    .load-more-comments:hover {
        text-decoration: underline;
    }
    
    .comment-actions .dropdown-menu {
        min-width: 100px;
    }
    
    .comment-actions .dropdown-item {
        padding: 0.25rem 1rem;
        font-size: 0.85rem;
    }
    
    .comment-actions .dropdown-item i {
        width: 18px;
        text-align: center;
        margin-right: 5px;
    }
    
    /* Estilo para o modal de imagem */
    .modal-image {
        max-width: 100%;
        height: auto;
    }
    
    /* Ajustes para o tema escuro */
    .dark-mode .post-image-container {
        background-color: #2d2d2d;
    }
    
    .dark-mode .post-image-container img {
        filter: brightness(0.9);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Adiciona funcionalidade para abrir a imagem em um modal ao clicar nela
document.addEventListener('DOMContentLoaded', function() {
    // Adiciona evento de clique nas imagens das postagens
    document.querySelectorAll('.post-image-container img').forEach(img => {
        img.style.cursor = 'zoom-in';
        img.addEventListener('click', function() {
            const modal = `
                <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content bg-transparent border-0">
                            <div class="modal-header border-0">
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                            </div>
                            <div class="modal-body text-center p-0">
                                <img src="${this.src}" class="img-fluid" alt="Imagem ampliada">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove o modal existente, se houver
            const existingModal = document.getElementById('imageModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Adiciona o novo modal ao body
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Inicializa o modal
            const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            imageModal.show();
            
            // Remove o modal do DOM quando fechado
            document.getElementById('imageModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        });
    });
});

// Variáveis globais
let isLoadingComments = false;

// Função para renderizar um comentário
function renderComment(comment) {
    const isOwner = comment.is_owner ? 'true' : 'false';
    const deleteButton = comment.is_owner ? 
        `<button class="btn btn-link text-danger p-0 ms-2 delete-comment" 
                data-comment-id="${comment.id}"
                data-bs-toggle="tooltip" 
                title="Excluir meu comentário">
            <i class="bi bi-trash" style="font-size: 0.8rem;"></i>
        </button>` : 
        ({{ request.user.is_superuser|yesno:'true,false' }} ? 
        `<button class="btn btn-link text-danger p-0 ms-2 delete-comment" 
                data-comment-id="${comment.id}"
                data-bs-toggle="tooltip" 
                title="Excluir comentário (Admin)">
            <i class="bi bi-trash" style="font-size: 0.8rem;"></i>
        </button>` : '');
    
    return `
        <div class="comment-item mb-3" data-comment-id="${comment.id}">
            <div class="d-flex">
                <div class="flex-shrink-0">
                    <i class="bi bi-person-circle me-2" style="font-size: 1.5rem;"></i>
                </div>
                <div class="ms-2">
                    <div class="d-flex align-items-center">
                        <strong class="me-2">${comment.user}</strong>
                        ${deleteButton}
                    </div>
                    <p class="mb-1">${comment.content}</p>
                    <small class="text-muted">${comment.created_at}</small>
                </div>
            </div>
        </div>`;
}

// Função para carregar mais comentários
function loadMoreComments(postId) {
    if (isLoadingComments) return;
    
    const commentsList = document.getElementById(`comments-list-${postId}`);
    const loadMoreButton = document.getElementById(`load-more-${postId}`);
    const noComments = document.getElementById(`no-comments-${postId}`);
    const nextPage = parseInt(commentsList.dataset.nextPage);
    
    if (!nextPage) return;
    
    isLoadingComments = true;
    
    // Mostra o spinner
    commentsList.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>`;
    
    // Faz a requisição para carregar mais comentários
    fetch(`/post/${postId}/load-more-comments/?page=${nextPage}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove o spinner
                commentsList.innerHTML = '';
                
                // Adiciona os novos comentários
                if (data.comments.length > 0) {
                    data.comments.forEach(comment => {
                        commentsList.insertAdjacentHTML('beforeend', renderComment(comment));
                    });
                    
                    // Atualiza a próxima página ou esconde o botão
                    if (data.has_more) {
                        commentsList.dataset.nextPage = data.next_page;
                        loadMoreButton.classList.remove('d-none');
                    } else {
                        loadMoreButton.classList.add('d-none');
                    }
                    
                    // Esconde a mensagem de nenhum comentário
                    noComments.classList.add('d-none');
                } else if (nextPage === 1) {
                    // Se não há comentários na primeira página
                    commentsList.innerHTML = '';
                    noComments.classList.remove('d-none');
                }
            }
        })
        .catch(error => {
            console.error('Erro ao carregar comentários:', error);
            commentsList.innerHTML = '<div class="text-danger text-center py-3">Erro ao carregar comentários. Tente novamente.</div>';
        })
        .finally(() => {
            isLoadingComments = false;
        });
}

// Função para carregar os primeiros comentários quando o botão de comentários for clicado
document.addEventListener('click', function(e) {
    const commentButton = e.target.closest('[data-bs-toggle="collapse"]');
    if (commentButton) {
        const targetId = commentButton.getAttribute('data-bs-target');
        const postId = targetId.replace('#comments-', '');
        const commentsList = document.getElementById(`comments-list-${postId}`);
        
        // Se ainda não carregou os comentários iniciais
        if (commentsList && commentsList.children.length === 1) {
            loadMoreComments(postId);
        }
    }
});

// Função para adicionar um novo comentário à lista
function addNewComment(postId, commentData) {
    const commentsList = document.getElementById(`comments-list-${postId}`);
    const noComments = document.getElementById(`no-comments-${postId}`);
    const loadMoreButton = document.getElementById(`load-more-${postId}`);
    
    // Se não houver comentários ainda, remove a mensagem de nenhum comentário
    if (noComments && !noComments.classList.contains('d-none')) {
        noComments.classList.add('d-none');
    }
    
    // Adiciona o novo comentário no início da lista
    if (commentsList) {
        // Se estiver mostrando o spinner, remove ele
        if (commentsList.children.length === 1 && commentsList.children[0].querySelector('.spinner-border')) {
            commentsList.innerHTML = '';
        }
        
        // Adiciona o novo comentário
        commentsList.insertAdjacentHTML('afterbegin', renderComment(commentData));
        
        // Mostra o botão de carregar mais se não estiver visível
        if (loadMoreButton) {
            loadMoreButton.classList.remove('d-none');
        }
        
        // Rola até o novo comentário
        const firstComment = commentsList.firstElementChild;
        if (firstComment) {
            firstComment.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
    
    // Atualiza a contagem de comentários
    updateCommentCount(postId, 1);
}

// Função para atualizar a contagem de comentários
function updateCommentCount(postId, increment) {
    const commentCountElement = document.getElementById(`comment-count-${postId}`);
    if (commentCountElement) {
        const currentCount = parseInt(commentCountElement.textContent) || 0;
        const newCount = Math.max(0, currentCount + increment); // Garante que não fique negativo
        commentCountElement.textContent = newCount;
        
        // Atualiza o texto plural/singular
        const commentTextElement = commentCountElement.nextElementSibling;
        if (commentTextElement) {
            commentTextElement.textContent = newCount === 1 ? ' comentário' : ' comentários';
        }
    }
}

// Função para obter o token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Executa quando o DOM estiver totalmente carregado
document.addEventListener('DOMContentLoaded', function() {
    const csrftoken = getCookie('csrftoken');
    
    // Inicializar tooltips do Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Função para atualizar a contagem de comentários
    function updateCommentCount(postId, increment) {
        const commentCount = document.getElementById(`comment-count-${postId}`);
        if (commentCount) {
            const newCount = parseInt(commentCount.textContent) + (increment ? 1 : -1);
            commentCount.textContent = newCount;
            const commentText = commentCount.nextElementSibling;
            commentText.textContent = newCount === 1 ? ' comentário' : ' comentários';
        }
    }
    
    // Adicionar evento de clique para excluir comentários
    document.addEventListener('click', function(e) {
        const deleteButton = e.target.closest('.delete-comment');
        if (deleteButton) {
            e.preventDefault();
            const commentId = deleteButton.getAttribute('data-comment-id');
            const commentItem = deleteButton.closest('.comment-item');
            const postId = commentItem.closest('.card').querySelector('[data-post-id]').dataset.postId;
            
            if (confirm('Tem certeza que deseja excluir este comentário?')) {
                fetch(`/comment/${commentId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove o comentário da interface
                        commentItem.remove();
                        // Atualiza a contagem de comentários
                        updateCommentCount(postId, false);
                    } else {
                        alert('Erro ao excluir o comentário: ' + (data.error || 'Erro desconhecido'));
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Ocorreu um erro ao tentar excluir o comentário.');
                });
            }
        }
    });

    // --- LÓGICA DE CURTIR ---
    const likeButtons = document.querySelectorAll('.like-button');
    likeButtons.forEach(button => {
        button.addEventListener('click', function (event) {
            event.preventDefault();
            const postId = this.dataset.postId;
            const url = `/post/${postId}/like/`;

            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById(`like-count-${postId}`).textContent = data.likes_count;
                const icon = this.querySelector('i');
                icon.classList.toggle('bi-heart', !data.liked);
                icon.classList.toggle('bi-heart-fill', data.liked);
                icon.classList.toggle('text-danger', data.liked);
            })
            .catch(error => console.error('Error liking post:', error));
        });
    });

    // --- LÓGICA DE COMENTAR ---
    document.addEventListener('submit', function(event) {
        const form = event.target.closest('.comment-form');
        if (!form) return;
        
        event.preventDefault();
        console.log("Comment form submission intercepted.");

        const postId = form.getAttribute('data-post-id');
        const formData = new FormData(form);
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.innerHTML;
        const commentsList = document.getElementById(`comments-list-${postId}`);
        const noComments = document.getElementById(`no-comments-${postId}`);

        // Desabilita o botão e mostra o spinner
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...';

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na resposta do servidor');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Limpa o formulário
                form.reset();
                
                // Adiciona o novo comentário à lista
                addNewComment(postId, data.comment);
                
                // Atualiza a contagem de comentários
                updateCommentCount(postId, 1);
                
                // Mostra mensagem de sucesso
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success alert-dismissible fade show mt-2';
                successAlert.role = 'alert';
                successAlert.innerHTML = `
                    Comentário adicionado com sucesso!
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                `;
                form.parentNode.insertBefore(successAlert, form.nextSibling);
                
                // Remove a mensagem após 3 segundos
                setTimeout(() => {
                    successAlert.classList.remove('show');
                    setTimeout(() => successAlert.remove(), 150);
                }, 3000);
            } else {
                throw new Error(data.errors || 'Erro ao adicionar comentário');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            const errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-danger alert-dismissible fade show mt-2';
            errorAlert.role = 'alert';
            errorAlert.innerHTML = `
                Erro ao adicionar comentário: ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            `;
            form.parentNode.insertBefore(errorAlert, form.nextSibling);
            
            // Remove a mensagem após 5 segundos
            setTimeout(() => {
                errorAlert.classList.remove('show');
                setTimeout(() => errorAlert.remove(), 150);
            }, 5000);
        })
        .finally(() => {
            // Restaura o botão
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        });
    });
});
</script>
{% endblock extra_js %}